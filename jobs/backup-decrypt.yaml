- job:
    name: auto-pipeline-backup-decrypt
    project-type: pipeline
    description: "This job moves a backup file onto a resotration server at decrypts it there."
    parameters:
      - string:
          name: backupIp
          description: "The IP address of the backup server"
      - string:
          name: backupFile
          description: "The backup file (including path)"
      - string:
          name: restorationServerIp
          description: "The IP address of the restoration server)"
    dsl: |
      node {
        stage('Decrypt Backup') {

          withCredentials([
            sshUserPrivateKey(credentialsId: 'ssh-backup-server', keyFileVariable: 'backupServerKey'),
            sshUserPrivateKey(credentialsId: 'ssh-restoration-server', keyFileVariable: 'restorationServerKey'),
            string(credentialsId: 'gpg-private-key1', variable: 'gpgKey'),
            usernamePassword(credentialsId: 'gpg-private-key-creds', passwordVariable: 'gpgPasswd', usernameVariable: 'gpgUname')]) {

              sh ''' echo $restorationServerIp '''

              println "Importing private key"
              sh ''' ssh -o StrictHostKeyChecking=no -i $restorationServerKey ec2-user@$restorationServerIp "echo -e $gpgKey > private-key" '''

              sh ''' ssh -i $restorationServerKey ec2-user@$restorationServerIp "gpg --allow-secret-key-import --import private-key" '''

              println "Creating 'decrypt' script"
              sh ''' ssh -i $restorationServerKey ec2-user@$restorationServerIp "echo -e '#!/bin/bash\necho \\$1 | gpg --batch --passphrase-fd 0 -r \\$2 --output \\$3 --decrypt \\$4' > decrypt.sh" '''

              sh ''' ssh -i $restorationServerKey ec2-user@$restorationServerIp "chmod +x decrypt.sh" '''

              println "Copying backup to test restoration server"
              sh ''' ssh -o StrictHostKeyChecking=no -i $backupServerKey ec2-user@$backupIp "scp -o StrictHostKeyChecking=no -i ~/.ssh/restoration-server.pem $backupFile ec2-user@$restorationServerIp:backup.json.gpg" '''

              println "Decrypting backup file"
              sh ''' ssh -i $restorationServerKey ec2-user@$restorationServerIp "./decrypt.sh $gpgPasswd $gpgUname 'backup.json' 'backup.json.gpg'" '''


              // Remove private-key-file
              sh ''' ssh -i $restorationServerKey ec2-user@$restorationServerIp "rm private-key" '''
          }
        }
      }